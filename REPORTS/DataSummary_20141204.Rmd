
```{r, echo=FALSE, warning=FALSE, results='hide', message=FALSE}
##==============================================================================
## INITIALIZE
##==============================================================================
## Remove all objects; perform garbage collection
rm(list=ls())
gc(reset=TRUE)
## Check for dependencies
if(!"geneorama" %in% rownames(installed.packages())){
    if(!"devtools" %in% rownames(installed.packages())){install.packages('devtools')}
    devtools::install_github('geneorama/geneorama')}
## Load libraries
geneorama::detach_nonstandard_packages()
geneorama::loadinstall_libraries(c("data.table", "ggplot2", "knitr"))
geneorama::set_project_dir("food-inspections-evaluation")
geneorama::sourceDir("../CODE/functions/")

opts_chunk$set(tidy = FALSE)
```

```{r, echo=FALSE, warning=FALSE, results='hide'}
##==============================================================================
## LOAD PREVIOUS DATA
##==============================================================================
geneorama::set_project_dir("food-inspections-evaluation")
local({
    #browser()})
    load("DATA/recreated_training_data_20141031v01.Rdata")
    dat_prev1 <<- as.data.table(rbind(train, tune))
    load("DATA/recreated_training_data_20141103v01.Rdata")
    dat_prev2 <<- as.data.table(rbind(train, tune, evaluate))
    load("DATA/recreated_training_data_20141103v02.Rdata")
    dat_prev3 <<- as.data.table(rbind(train, tune, evaluate))
})
dat_prev1
dat_prev2
dat_prev3
```

```{r, echo=FALSE, warning=FALSE, results='hide'}
##==============================================================================
## LOAD NEW DATA
##==============================================================================
geneorama::set_project_dir("food-inspections-evaluation")
dat <- readRDS("DATA/20141110/dat_with_inspector.Rds")
##==============================================================================
## EDIT TO MATCH PREVIOUS DATA
##==============================================================================
## Remove NA's
dat[,.N,is.na(heat_burglary)]
dat <- dat[!is.na(heat_burglary)]
## Add criticalFound variable to dat:
dat[ , criticalFound := pmin(1, criticalCount)]
## Set the key for dat
setkey(dat, Inspection_ID)
## Match time period of original results
dat <- dat[Inspection_Date < "2013-08-30"]
## Remove records where an inspection didn't happen
dat[, .N, Results]
dat <- dat[!Results %in% c('Out of Business','Business Not Located','No Entry')]
## Get down to just the relevant columns
colnames(dat_prev1)
# geneorama::clipper(colnames(dat_prev1))
dat <- dat[ , list(
    inspection_id = Inspection_ID, license = License, 
    facility_type = Facility_Type, risk = Risk, 
    inspection_date = Inspection_Date, inspection_type = Inspection_Type, 
    results = Results, pass_flag = pass_flag, criticalCount, seriousCount, 
    minorCount, pastFail, pastCritical, pastSerious, pastMinor, timeSinceLast, 
    firstRecord, minDate, maxDate, payment_date = NA_character_, 
    license_start_date = LICENSE_TERM_START_DATE, 
    expiration_date = LICENSE_TERM_EXPIRATION_DATE, 
    doing_business_as_name = DOING_BUSINESS_AS_NAME, address = ADDRESS, 
    city = CITY, state = STATE, zip_code = ZIP_CODE, ward = WARD, 
    precinct = PRECINCT, police_district = POLICE_DISTRICT, 
    license_description = LICENSE_DESCRIPTION, latitude = Latitude, 
    longitude = Longitude, location = Location, criticalFound, ageAtInspection, 
    consumption_on_premises_incidental_activity, tobacco_retail_over_counter, 
    limited_business_license, package_goods, outdoor_patio, 
    public_place_of_amusement, tavern, retail_food_establishment = NA_integer_, 
    caterers_liquor_license, filling_station, precipIntensity, temperatureMax, 
    windSpeed, humidity, heat_burglary, heat_sanitation, heat_garbage)]

## Convert inspection id to character to match previous data 
dat[ , inspection_id:= as.character(inspection_id)]
```


## Comparison of previous data to current data

Object    | Source File
----------|---------------------------------------------------
dat_prev1 | "DATA/recreated_training_data_20141031v01.Rdata"
dat_prev2 | "DATA/recreated_training_data_20141103v01.Rdata"
dat_prev3 | "DATA/recreated_training_data_20141103v02.Rdata"
dat       | "DATA/20141110/dat_with_inspector.Rds"


dat has been modified to match the original files:

 * The date range is shortened to match the previous examples
 * The column names are modified to match

The object `dat` has also been filtered, processed, and joined to other data. This process followed similar steps compared to the steps taken for `dat_prev1`, `dat_prev2`, `dat_prev3`.

### This is the "xmat" used in the model

Not all of the columns matter directly.

```{r}
# xmat <- dat[ , list(criticalFound,
#                     Inspector_Assigned,
#                     pastSerious = pmin(pastSerious, 1),
#                     ageAtInspection = ifelse(ageAtInspection > 4, 1L, 0L),
#                     pastCritical = pmin(pastCritical, 1),
#                     consumption_on_premises_incidental_activity,
#                     tobacco_retail_over_counter,
#                     temperatureMax,
#                     heat_burglary = pmin(heat_burglary, 70),
#                     heat_sanitation = pmin(heat_sanitation, 70),
#                     heat_garbage = pmin(heat_garbage, 50),
#                     # risk = as.factor(Risk),
#                     # facility_type = as.factor(Facility_Type),
#                     timeSinceLast),
#             keyby = "Inspection_ID"]
```


## Basic Summaries of the data


### The column names (same for all files):
```{r, echo=FALSE}
cat(paste(paste0("[", 1:ncol(dat), "]"), colnames(dat), collapse = ", "))
```

### The dimensions and column names of each file:

```{r}
dim(dat)
dim(dat_prev1)
dim(dat_prev2)
dim(dat_prev3)
```

### The count of inspections per month:

```{r, echo=FALSE}
## Four way merge keyed by YearMonth, which is the rounded inspection date:
dat[,list(`   dat`=.N), keyby=list(YearMonth=round(inspection_date, "month"))][
    dat_prev1[,list(datprev1=.N), 
              keyby=list(YearMonth=round(as.IDate(inspection_date), "month"))]][
        dat_prev2[,list(datprev2=.N), 
                  keyby=list(YearMonth=round(as.IDate(inspection_date), "month"))]][
            dat_prev3[,list(datprev3=.N), 
                      keyby=list(YearMonth=round(as.IDate(inspection_date), "month"))]]
```

### Summary of Critical Counts for each file

```{r, echo=FALSE}
temp0 <- dat[ , .N, keyby=criticalCount][,list(criticalCount, N, pct=round(N/sum(N), 3))]
temp1 <- dat_prev1[ , .N, keyby=criticalCount][,list(criticalCount, N, pct=round(N/sum(N), 3))]
temp2 <- dat_prev2[ , .N, keyby=criticalCount][,list(criticalCount, N, pct=round(N/sum(N), 3))]
temp3 <- dat_prev3[ , .N, keyby=criticalCount][,list(criticalCount, N, pct=round(N/sum(N), 3))]
setkey(temp0, criticalCount);setkey(temp1, criticalCount)
setkey(temp2, criticalCount);setkey(temp3, criticalCount)
setnames(temp0, c('criticalCount', 'N', 'pct'), c('crit_count', '    dat', 'pct0'))
setnames(temp1, c('criticalCount', 'N', 'pct'), c('crit_count', 'datprev1', 'pct1'))
setnames(temp2, c('criticalCount', 'N', 'pct'), c('crit_count', 'datprev2', 'pct2'))
setnames(temp3, c('criticalCount', 'N', 'pct'), c('crit_count', 'datprev3', 'pct3'))
temp0[temp1[temp2[temp3]]]
rm(temp0, temp1, temp2, temp3)
```

### Summary of 'criticalFound' for each file

```{r, echo=FALSE}
temp0 <- dat[ , .N, keyby=criticalFound][,list(criticalFound, N, pct=round(N/sum(N), 3))]
temp1 <- dat_prev1[ , .N, keyby=criticalFound][,list(criticalFound, N, pct=round(N/sum(N), 3))]
temp2 <- dat_prev2[ , .N, keyby=criticalFound][,list(criticalFound, N, pct=round(N/sum(N), 3))]
temp3 <- dat_prev3[ , .N, keyby=criticalFound][,list(criticalFound, N, pct=round(N/sum(N), 3))]
setkey(temp0, criticalFound);setkey(temp1, criticalFound)
setkey(temp2, criticalFound);setkey(temp3, criticalFound)
setnames(temp0, c('criticalFound', 'N', 'pct'), c('crit_found', '    dat', 'pct0'))
setnames(temp1, c('criticalFound', 'N', 'pct'), c('crit_found', 'datprev1', 'pct1'))
setnames(temp2, c('criticalFound', 'N', 'pct'), c('crit_found', 'datprev2', 'pct2'))
setnames(temp3, c('criticalFound', 'N', 'pct'), c('crit_found', 'datprev3', 'pct3'))
temp0[temp1[temp2[temp3]]]
rm(temp0, temp1, temp2, temp3)
```

### Summary of 'facility_type'

Originally 'facility_type' wasn't cleaned up... 

```{r}
dat[ , .N, facility_type][order(-N)]

## Create new column, facility_type_clean, to match previous data
## Note, `invisible` is needed to keep from printing in knitr... this will be 
## fixed in data.table 1.9.6 see 
## http://stackoverflow.com/questions/15267018/knitr-gets-tricked-by-data-table-assignment
invisible(dat[grep("restaurant", facility_type, ignore.case=T), facility_type_clean:="Restaurant"])
invisible(dat[grep("grocery", facility_type, ignore.case=T), facility_type_clean:="Grocery Store"])
invisible(dat[which(is.na(facility_type_clean)), facility_type_clean:="Other"])
dat[ , .N, facility_type_clean][order(-N)]
```

Summary of 'facility_type' after cleaning

```{r, echo=FALSE}
temp0 <- dat[ , .N, keyby=list(facility_type=facility_type_clean)][order(-N)]
temp1 <- dat_prev1[ , .N, keyby=facility_type][order(-N)]
temp2 <- dat_prev2[ , .N, keyby=facility_type][order(-N)]
temp3 <- dat_prev3[ , .N, keyby=facility_type][order(-N)]
setkey(temp0, facility_type);setkey(temp1, facility_type)
setkey(temp2, facility_type);setkey(temp3, facility_type)
setnames(temp0, 'N', '    dat');setnames(temp1, 'N', 'datprev1')
setnames(temp2, 'N', 'datprev2');setnames(temp3, 'N', 'datprev3')
temp0[temp1[temp2[temp3]]]
rm(temp0, temp1, temp2, temp3)
```

### Summary of 'risk' (DATA DOESN'T MATCH)

```{r, echo=FALSE}
dat[ , list(`     dat`=.N), keyby=risk][order(-`     dat`)][
    dat_prev1[ , list(datprev1=.N), keyby=risk][order(-datprev1)]][
        dat_prev2[ , list(datprev2=.N), keyby=risk][order(-datprev2)]][
            dat_prev3[ , list(datprev3=.N), keyby=risk][order(-datprev3)]]
```

### ******* THIS ONE LOOKS BAD! 
### Summary of 'pastSerious'
```{r, echo=FALSE}
# dat[ , .N, keyby=pastSerious][,list(pastSerious, N, percent=round(N/sum(N), 3))]
# dat_prev1[ , .N, keyby=pastSerious][,list(pastSerious, N, percent=round(N/sum(N), 3))]
# dat_prev2[ , .N, keyby=pastSerious][,list(pastSerious, N, percent=round(N/sum(N), 3))]
# dat_prev3[ , .N, keyby=pastSerious][,list(pastSerious, N, percent=round(N/sum(N), 3))]
temp0 <- dat[ , .N, keyby=pastSerious][,list(pastSerious, N, pct=round(N/sum(N), 3))]
temp1 <- dat_prev1[ , .N, keyby=pastSerious][,list(pastSerious, N, pct=round(N/sum(N), 3))]
temp2 <- dat_prev2[ , .N, keyby=pastSerious][,list(pastSerious, N, pct=round(N/sum(N), 3))]
temp3 <- dat_prev3[ , .N, keyby=pastSerious][,list(pastSerious, N, pct=round(N/sum(N), 3))]
setkey(temp0, pastSerious);setkey(temp1, pastSerious)
setkey(temp2, pastSerious);setkey(temp3, pastSerious)
setnames(temp0, c('pastSerious', 'N', 'pct'), c('pastSerious', '    dat', 'pct0'))
setnames(temp1, c('pastSerious', 'N', 'pct'), c('pastSerious', 'datprev1', 'pct1'))
setnames(temp2, c('pastSerious', 'N', 'pct'), c('pastSerious', 'datprev2', 'pct2'))
setnames(temp3, c('pastSerious', 'N', 'pct'), c('pastSerious', 'datprev3', 'pct3'))
temp0[temp1[temp2[temp3]]]
rm(temp0, temp1, temp2, temp3)
```

### ******* THIS ONE LOOKS BAD! 
### Summary of 'pastCritical'
```{r, echo=FALSE}
# dat[ , .N, keyby=pastCritical][,list(pastCritical, N, percent=round(N/sum(N), 3))]
# dat_prev1[ , .N, keyby=pastCritical][,list(pastCritical, N, percent=round(N/sum(N), 3))]
# dat_prev2[ , .N, keyby=pastCritical][,list(pastCritical, N, percent=round(N/sum(N), 3))]
# dat_prev3[ , .N, keyby=pastCritical][,list(pastCritical, N, percent=round(N/sum(N), 3))]
temp0 <- dat[ , .N, keyby=pastCritical][,list(pastCritical, N, pct=round(N/sum(N), 3))]
temp1 <- dat_prev1[ , .N, keyby=pastCritical][,list(pastCritical, N, pct=round(N/sum(N), 3))]
temp2 <- dat_prev2[ , .N, keyby=pastCritical][,list(pastCritical, N, pct=round(N/sum(N), 3))]
temp3 <- dat_prev3[ , .N, keyby=pastCritical][,list(pastCritical, N, pct=round(N/sum(N), 3))]
setkey(temp0, pastCritical);setkey(temp1, pastCritical)
setkey(temp2, pastCritical);setkey(temp3, pastCritical)
setnames(temp0, c('pastCritical', 'N', 'pct'), c('pastCritical', '    dat', 'pct0'))
setnames(temp1, c('pastCritical', 'N', 'pct'), c('pastCritical', 'datprev1', 'pct1'))
setnames(temp2, c('pastCritical', 'N', 'pct'), c('pastCritical', 'datprev2', 'pct2'))
setnames(temp3, c('pastCritical', 'N', 'pct'), c('pastCritical', 'datprev3', 'pct3'))
temp0[temp1[temp2[temp3]]]
rm(temp0, temp1, temp2, temp3)
```


### Summary of 'ageAtInspection'
```{r}
## Four way merge keyed by ageAtInspection, which is the rounded ageAtInspection:
## (only right join here)
dat[,list(`   dat`=.N), keyby=list(ageAtInspection=round(ageAtInspection, 0))][
    dat_prev1[,list(datprev1=.N), 
              keyby=list(ageAtInspection=round(ageAtInspection, 0))]][
        dat_prev2[,list(datprev2=.N), 
                  keyby=list(ageAtInspection=round(ageAtInspection, 0))]][
            dat_prev3[,list(datprev3=.N), 
                      keyby=list(ageAtInspection=round(ageAtInspection, 0))]]
```

dat actually has some older "age at inspection" times, but they got lost in the "right join" nature of the data.table joins above, and they look fine.

```{r}
dat[,list(`   dat`=.N), keyby=list(ageAtInspection=round(ageAtInspection, 0))]
```

### Summary of 'temperatureMax'
```{r}
temp0 <- dat[,list(`   dat`=.N), keyby=list(temperatureMax=round(temperatureMax, 0))]
temp1 <- dat_prev1[,list(datprev1=.N), keyby=list(temperatureMax=round(temperatureMax, 0))]
temp2 <- dat_prev2[,list(datprev2=.N), keyby=list(temperatureMax=round(temperatureMax, 0))]
temp3 <- dat_prev3[,list(datprev3=.N), keyby=list(temperatureMax=round(temperatureMax, 0))]
temp0[temp1[temp2[temp3]]][J(temperatureMax=17:97)]
rm(temp0, temp1, temp2, temp3)
```

### Summary of 'timeSinceLast'
```{r}
temp0 <- dat[,list(`   dat`=.N), keyby=list(timeSinceLast=round(timeSinceLast, 1))]
temp1 <- dat_prev1[,list(datprev1=.N), keyby=list(timeSinceLast=round(timeSinceLast, 1))]
temp2 <- dat_prev2[,list(datprev2=.N), keyby=list(timeSinceLast=round(timeSinceLast, 1))]
temp3 <- dat_prev3[,list(datprev3=.N), keyby=list(timeSinceLast=round(timeSinceLast, 1))]
temp0[temp1[temp2[temp3]]]
rm(temp0, temp1, temp2, temp3)
```






## Reconcilation of critical found

```{r}
geneorama::set_project_dir("food-inspections-evaluation")

## Merge dat and dat_prev3
datmerge <- merge(dat, dat_prev3, by = "inspection_id", all=TRUE)
## Examine the differences in critical violations
datmerge[ , diffcrit:=pastCritical.x-pastCritical.y]
datmerge[,.N,keyby=diffcrit]
datmerge[,.N,keyby=list(diffcrit, pastCritical.x, pastCritical.y)]
## zero in on cases where it was 2 and now it's 0
datmerge[pastCritical.x==2 & pastCritical.y==0, 
         .N, 
         keyby=list(doing_business_as_name.x, license)]

## Example of a difference: GOLDEN APPLE CAFE & BAKERY
dat[doing_business_as_name=='GOLDEN APPLE CAFE & BAKERY']
dat_prev3[doing_business_as_name=='GOLDEN APPLE CAFE & BAKERY']

## Read in raw food inspection data and recalculate violation matrix
## (also did this in excel with identical results)
foodInspect <- readRDS("DATA/20141110/food_inspections.Rds")
# foodInspect[License==2009150]
temp <- foodInspect[License==2009150, .SD, keyby=Inspection_Date]
vio <- strsplit(temp$Violations,"| ",fixed=T)
vio_nums <- lapply(vio, 
                   function(item) regmatches(x = item, 
                                             m = gregexpr(pattern = "^[0-9]+", 
                                                          text = item)))
vio_mat <- geneorama::list2matrix(vio_nums, count = T)
vio_mat <- vio_mat[ , order(as.numeric(colnames(vio_mat)))]
vio_mat
manualsummary <- data.table(inspection_id = as.character(temp$Inspection_ID),
                            inspection_date = temp$Inspection_Date,
                            crit = apply(vio_mat[ , colnames(vio_mat) %in% 1:14], 1, sum),
                            serious = apply(vio_mat[ , colnames(vio_mat) %in% 15:29], 1, sum),
                            minor = apply(vio_mat[ , colnames(vio_mat) %in% 30:44], 1, sum))
manualsummary
manualsummary[inspection_id%in% dat$inspection_id]
# vio[which(manualsummary$inspection_id%in% dat$inspection_id)]
gsub("\n", "", vio[which(manualsummary$inspection_id%in% dat$inspection_id)])

# geneorama::clipper(temp)
dat[license==2009150, pastCritical, keyby=list(inspection_date, inspection_id)]
dat_prev1[license_=='2009150', pastCritical, keyby=list(inspection_date, inspection_id)]
dat_prev2[license_=='2009150', pastCritical, keyby=list(inspection_date, inspection_id)]
dat_prev3[license_=='2009150', pastCritical, keyby=list(inspection_date, inspection_id)]
```



















