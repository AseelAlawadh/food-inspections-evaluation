
```{r, echo=FALSE, results='hide'}
##==============================================================================
## INITIALIZE
##==============================================================================
## Remove all objects; perform garbage collection
rm(list=ls())
gc(reset=TRUE)
## Check for dependencies
if(!"geneorama" %in% rownames(installed.packages())){
    if(!"devtools" %in% rownames(installed.packages())){install.packages('devtools')}
    devtools::install_github('geneorama/geneorama')}
## Load libraries
geneorama::detach_nonstandard_packages()
# geneorama::loadinstall_libraries(c("geneorama", "data.table"))
geneorama::loadinstall_libraries(c("data.table", "glmnet", "ggplot2", "splines"))
geneorama::set_project_dir("food-inspections-evaluation")
geneorama::sourceDir("CODE/functions/")

## Define melt to be the data.table melt
melt <- data.table:::melt.data.table

##==============================================================================
## LOAD CACHED RDS FILES
##==============================================================================
dat <- readRDS("DATA/dat_model.Rds")

## Only keep "Retail Food Establishment"
dat <- dat[LICENSE_DESCRIPTION == "Retail Food Establishment"]
## Remove License Description
dat[ , LICENSE_DESCRIPTION := NULL]
dat <- na.omit(dat)

## Add criticalFound variable to dat:
dat[ , criticalFound := pmin(1, criticalCount)]

## Set the key for dat
setkey(dat, Inspection_ID)

## Match time period of original results
# dat <- dat[Inspection_Date < "2013-09-01" | Inspection_Date > "2014-07-01"]

##==============================================================================
## CREATE MODEL DATA
##==============================================================================
# sort(colnames(dat))
xmat <- dat[ , list(criticalFound,
                    # Inspector = Inspector_Grade, 
                    Inspector = Inspector_Assigned,
                    pastSerious = pmin(pastSerious, 1),
                    ageAtInspection = ifelse(ageAtInspection > 4, 1L, 0L),
                    pastCritical = pmin(pastCritical, 1),
                    consumption_on_premises_incidental_activity,
                    tobacco_retail_over_counter,
                    temperatureMax,
                    heat_burglary = pmin(heat_burglary, 70),
                    heat_sanitation = pmin(heat_sanitation, 70),
                    heat_garbage = pmin(heat_garbage, 50),
                    # risk = as.factor(Risk),
                    # facility_type = as.factor(Facility_Type),
                    timeSinceLast),
            keyby = Inspection_ID]
mm <- model.matrix(criticalFound ~ . -1, data=xmat[ , -1, with=F])
mm <- as.data.table(mm)
str(mm)
colnames(mm)

##==============================================================================
## CREATE TEST / TRAIN PARTITIONS
##==============================================================================
## 2014-07-01 is an easy separator
dat[Inspection_Date < "2014-07-01", range(Inspection_Date)]
dat[Inspection_Date > "2014-07-01", range(Inspection_Date)]

iiTrain <- dat[ , which(Inspection_Date < "2014-07-01")]
iiTest <- dat[ , which(Inspection_Date > "2014-07-01")]

## Check to see if any rows didn't make it through the model.matrix formula
nrow(dat)
nrow(xmat)
nrow(mm)

##==============================================================================
## GLMNET MODEL
##==============================================================================
# fit ridge regression, alpha = 0, only inspector coefficients penalized
pen <- ifelse(grepl("^Inspector", colnames(mm)), 1, 0)
model <- glmnet(x = as.matrix(mm[iiTrain]),
                y = xmat[iiTrain,  criticalFound],
                family = "binomial", 
                alpha = 0,
                penalty.factor = pen)
## manual lambda selection
w.lam <- 100
lam <- model$lambda[w.lam]


## ATTACH PREDICTIONS TO DAT
dat$glm_pred <- predict(model, 
                        newx = as.matrix(mm), 
                        s = lam,
                        type = "response")[,1]
## Subset test period
datTest <- dat[iiTest]
geneorama::lll()
rm(pen, model, w.lam, mm, dat, iiTest, iiTrain, xmat, lam)
```

```{r, echo=FALSE, results='hide'}
##==============================================================================
## DEFINE CUSTOM GGPLOT FUNCTION
##==============================================================================

# cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
#                "#0072B2", "#D55E00", "#CC79A7")

ggplot <- function(...) {
    cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", 
               "#0072B2", "#D55E00", "#CC79A7")
    ggplot2::ggplot(...) +
        theme_grey()+
        scale_fill_manual(values=cbPalette) +
        scale_colour_manual(values=cbPalette) +
        theme(plot.title = element_text(size = 20))
    
}
```

```{r, echo=FALSE, eval=FALSE}
## Testing palette
cbPalette <- c("#000000", "#E69F00", "#56B4E9", 
               "#009E73", "#F0E442", "#0072B2", 
               "#D55E00", "#CC79A7")
pie(rep(1,length(cbPalette)), col = cbPalette)
```


## Aggregate count comparisons

```{r}
comp <- cbind(
    datTest[i = order(Inspection_Date), 
            j = list(Inspection_ID_BAU   = Inspection_ID,
                     Inspection_Date   = Inspection_Date,
                     criticalFound_BAU     = criticalFound)],
    datTest[i = order(-glm_pred), 
            j = list(Inspection_ID_Model   = Inspection_ID,
                     criticalFound_Model   = criticalFound)])
comp[ , Best_Possible := criticalFound_Model[order(-criticalFound_Model)]]
comp[ , Worst_Possible := criticalFound_Model[order(criticalFound_Model)]]
comp

comp_summary <- comp[
    i = TRUE, 
    j = list(Total_Inspections = .N,
             Crit_Violations_BAU = sum(criticalFound_BAU),
             Crit_Violations_Model = sum(criticalFound_Model),
             Best_Possible = sum(Best_Possible),
             Worst_Possible = sum(Worst_Possible)), 
    keyby = list(Inspection_Date = Inspection_Date)]



```

## Calculation of average time saved with model

```{r}
date_comp <- merge(
    x = comp[i = TRUE,
             j = list (criticalFound_BAU,
                       date_bau = Inspection_Date,
                       id = Inspection_ID_BAU)],
    y = comp[i = TRUE,
             j = list (criticalFound_Model,
                       date_model = Inspection_Date,
                       id = Inspection_ID_Model)],
    by = "id")
```

### Average improvement based on date comparison

```{r}
date_comp[i = criticalFound_Model==1,
          j = mean(date_model - date_bau)]
```

### Distribution of "how many days sooner" for all critical violations

```{r}
hist(as.numeric(date_comp[criticalFound_Model==1,
          -(date_model - date_bau)]),
     main = paste0("Days sooner that a critical \n",
                   " violation would have been discovered"),
     breaks = 30, 
     xlab = "days sooner",
     col = c(rep("#CC79A7", 10), rep("#009E73", 20)))
```

```{r}
hist(as.numeric(date_comp[criticalFound_Model==1,
          -(date_model - date_bau)]),
     main = paste0("Days sooner that a critical \n",
                   " violation would have been discovered"),
     breaks = 5, 
     xlab = "days sooner",
     col = c(rep("#CC79A7", 3), rep("#009E73", 10)))
```



```{r, eval=FALSE, echo=FALSE, results='hide'}
## Unadjusted plot
ggplot(
    melt(data = comp_summary[
        i = -1,
        j = list(Crit_Violations_BAU / Total_Inspections,
                 Crit_Violations_Model / Total_Inspections),
        keyby = Inspection_Date], 
        id.vars = "Inspection_Date")) +
    aes(x=Inspection_Date, y=value, colour=variable) + 
    labs(title=paste0("Percent of inspections resulting in a Critical Violation\n",
                      "(Daily intervals shown)\n"))+
    geom_line()
         
    

# geneorama::clipper(comp_summary)
```

```{r}
summary_percent_melted <- melt(
    data = comp_summary[
        i = -1,
        j = list(Pct_Crit_Violations_Found_BAU = Crit_Violations_BAU / Total_Inspections,
                 Pct_Crit_Violations_Found_Model = Crit_Violations_Model / Total_Inspections),
        keyby = Inspection_Date], 
    id.vars = "Inspection_Date")

ggplot(summary_percent_melted) +
    aes(x=Inspection_Date, y=value, colour=variable, fill=variable) + 
    labs(title=paste0('Critical violations found on a daily basis\n',
                      'as a percent of total inspections performed\n',
                      "(smoothed results)\n") ) +
    stat_smooth(method = "gam", 
                formula = y ~ s(x, k=10, sp=2, bs="ps"), 
                alpha=.3,
                level = .65)
```


## Count comparisons (cumulative)


```{r}
comp_summary_cumsum <- comp_summary[
    i = TRUE,
    j = list(Inspection_Date = Inspection_Date,
             BAU = cumsum(Crit_Violations_BAU),
             Model = cumsum(Crit_Violations_Model),
             Best_Possible = cumsum(Best_Possible),
             Worst_Possible = cumsum(Worst_Possible))]

comp_summary_cumsum_melted <- melt(
    data = comp_summary_cumsum, 
    id.vars = "Inspection_Date")

ggplot(comp_summary_cumsum_melted) +
    aes(x=Inspection_Date, y=value, colour=variable) + 
    labs(title=paste0("Cumulative Critical Violations Found\n",
                      "BAU Versus Model\n")) +
    geom_line(lwd=1.5)
```

```{r}
comp_summary_cumsum_diff <- comp_summary_cumsum[
    i = TRUE,
    j = list(Inspection_Date, 
             diff = Model - BAU)]

ggplot(comp_summary_cumsum_diff) +
    aes(x=Inspection_Date, y=diff) + 
    labs(title=paste0("Difference Between BAU and Modeled\n",
                      "Cumulative Critical Violations Found\n")) +
    ylab("Cumulative Difference of Critical Violations Found") +
    geom_line()
# geneorama::clipper(comp_summary)
```




```{r}
# bau <- datTest[
#     i = TRUE, 
#     j = list(criticalFound, Inspection_ID),
#     keyby =list(Inspection_Date)]
# print(mod, 100)
# mod <- datTest[
#         i = order(-glm_pred) , 
#         list(Inspection_Date_Model = Inspection_Date, 
#              criticalFound_Model = criticalFound,
#              Inspection_ID)]
# comp
# 
# summary_agg_dates <- comp[
#     i = TRUE, 
#     j = list(total_crit_found_bau = sum(criticalFound),
#              total_crit_found_mod = sum(criticalFound_Model)), 
#     keyby = Inspection_Date]
# 
# summary_agg_dates
# 
# comp[criticalFound == 1 , 
#      Inspection_Date_Model - Inspection_Date]
# 
# geneorama::wtf(datTest)
# dat
```



